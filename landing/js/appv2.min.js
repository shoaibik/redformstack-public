$ = null;


var app = {
    companies: [],
    formId: null,
    pricingPage: false,
    lifeWorksForm: false,
    skipForm: false,
    vipForm: true,
    preferredForm: true,
    referralsForm: false,
    bannerSection: null,
    formValid: true,
    companyValid: false,
    submitText: 'Submit',
    couponVerified: false,
    couponInput: null,
    employee: null,
    company: null,
    companyInput: null,
    notListed: "OTHER (COMPANY NOT LISTED)",
    URL: new URL(window.location.href),

    beforeInit: function () {
        if (!window.jQuery) {
            app.loadjQuery();
        }
        app.loadCompanies();
    },
    init: function () {
        $('form.fsForm').addClass('loading');

        app.initFormType();
        app.initPricingPage();


        app.initRefereralForm();


        app.initSkipForm();

        app.initOutFunnel();
        app.initCompany();

        app.initBanners();

        app.initCompanyAutocomplete();

        app.initCoupon();
        app.initEmployee();

        app.initBeforeSubmit();
        app.initOnSubmit();

        app.onLoad();
    },

    onLoad: function () {
        //window.addEventListener('load', function () {
            
            $('form.fsForm').removeClass('loading');
            app.bannerSection.find("img").each(function () {
                $(this).attr("src", $(this).attr("data-src"));
            });
        //});
    },

    initFormType: function () {
        var formId = $('form input[name="form"]').val();
        if (formId) {
            app.formId = formId.toString();
            switch (app.formId) {
                case "4155515":
                    app.skipForm = true;
                    break;
                case "4270738":
                    app.lifeWorksForm = true;
                    break;
                //                case "4140040":
                case "4326709":
                    app.vipForm = true;
                    app.loadGTranslate();
                    break;
                case "4155425":
                    app.preferredForm = true;
                case "4168329":
                    app.referralsForm = true;
                    app.initRefereralForm();
                    break;
            }
        }
    },
    initBeforeSubmit: function () {
        $('.fsSubmitButton').on('mouseup', function () {
            //app.validateBeforeSubmit();
        });
    },
    validateBeforeSubmit: function () {
        console.log('aaa');
        app.companyInput.val(app.companyInput.val().toUpperCase());
        if (app.companies.map(c => c.c).indexOf(app.companyInput.val()) === -1 && app.companyInput.val() !== app.notListed) {
            app.formValid = false;
            app.companyValid = false;
            app.submitText = $(this).val();
            app.companyInput.closest('.fsRowBody').find('button').trigger("click");

            if ($('[fs-field-validation-name="pricing"] input').length > 0) {
                $('[fs-field-validation-name="pricing"] input').val("");
            }
        }else{
            app.formValid = true;
            app.companyValid = true;
        }
    },
    initOnSubmit: function () {
        $('.fsForm').on("submit", function (e) {
            app.formValid = false;
            app.validateBeforeSubmit();

            if (app.referralsForm) {
                app.formValid = true;
            }
            
            if (!app.pricingPage && app.formValid === false) {
                e.preventDefault(); 
                setTimeout(function () {
                    $('.fsSubmitButton').val(app.submitText);
                }, 100);
                if(app.companyValid===false){
                    setTimeout(() => {
                        app.companyInput.closest('.fsRowBody').addClass('fsValidationError');
                    }, 200);
                }
                return;
            }

            var campaign_source = app.URL.searchParams.get("utm_source");
            var campaign_term = app.URL.searchParams.get("utm_term");
            var campaign_medium = app.URL.searchParams.get("utm_medium");
            var campaign_content = app.URL.searchParams.get("utm_content");
            var campaign_name = app.URL.searchParams.get("utm_campaign");

            if (app.lifeWorksForm) {
                campaign_term = "LifeWorks";
            }
            if (campaign_source) {
                $('[fs-field-validation-name="Campaign Source"] input').val(campaign_source);
            }
            if (campaign_term) {
                $('[fs-field-validation-name="Campaign Term"] input').val(campaign_term);
            }

            if (campaign_medium) {
                $('[fs-field-validation-name="Campaign Medium"] input').val(campaign_medium);
            }

            if (campaign_content) {
                $('[fs-field-validation-name="Campaign Content"] input').val(campaign_content);
            }

            if (campaign_name) {
                $('[fs-field-validation-name="Campaign Name"] input').val(campaign_name);
            }

            if (app.lifeWorksForm) {
                if (!app.pricingPage && app.couponVerified === false) {

                    e.preventDefault();
                    app.couponInput.closest('.fsRowBody').addClass('fsValidationError');
                    app.couponInput.focus();
                    setTimeout(function () {
                        $('.fsSubmitButton').val(submitText);
                    }, 100);
                }

                company = app.companyInput.val().toUpperCase();

                if (company !== "SKIPTHEDISHES COURIER") {
                    if (otherCompanies.rpp.map(c => c.c.toUpperCase()).indexOf(company) !== -1) {
                        $('[fs-field-validation-name="pricing"] input').val("RPP PRICING");
                    } else if (otherCompanies.cbu.map(c => c.c.toUpperCase()).indexOf(company) !== -1) {
                        $('[fs-field-validation-name="pricing"] input').val("CBU PRICING");
                    }

                }
            }
            if (app.pricingPage && app.companyInput.val() !== "") {
                e.preventDefault();
                window.location.href = "http://sellcell.formstack.com/forms/rpp?company=" + app.companyInput.val() + "&pricing=" + $('[fs-field-validation-name="pricing"] input').val()
                return;
            }

            if ($('#thanks').length > 0 && !app.skipForm) {
                if (companyInput.val() === app.notListed || companyInput.val() === "SKIPTHEDISHES COURIER" || app.isDirectCompany(companyInput.val().toUpperCase())) {
                    e.preventDefault();
                    var form = $(this);
                    var url = form.attr('action');

                    var employeeName = '';
                    if (employee && employee !== "Red Logistics") {
                        employeeName = '?Employee=' + $("[fs-field-validation-name=Employee] select").val();
                    }

                    var xhr;
                    var _orgAjax = jQuery.ajaxSettings.xhr;
                    $.ajaxSettings.xhr = function () {
                        xhr = _orgAjax();
                        return xhr;
                    };


                    $.ajax({
                        type: "POST",
                        url: url,
                        data: form.serialize(),
                        success: function (data, textStatus, request) {
                            if ((app.vipForm || app.preferredForm || app.lifeWorksForm) && app.companyInput.val() === app.notListed) {
                                return;
                            }

                            if (app.companyInput.val() === "SKIPTHEDISHES COURIER") {
                                window.location.href = "https://www.redwireless.ca/courier" + employeeName;
                            } else if (otherCompanies.direct && otherCompanies.direct.indexOf(app.companyInput.val().toUpperCase()) !== -1) {
                                window.location.href = "https://www.redwireless.ca/direct" + employeeName;
                            } else {
                                if (xhr.responseURL) {
                                    window.location.href = xhr.responseURL;
                                } else {
                                    window.location.href = "https://sellcell.formstack.com/forms/rpp?Company=" + app.companyInput.val().toUpperCase()
                                }
                            }
                        },
                        error: function (request, textStatus, errorThrown) {
                            if ((app.vipForm || app.preferredForm || app.lifeWorksForm) && app.companyInput.val() === app.notListed) {
                                return;
                            }
                            if (app.companyInput.val() === "SKIPTHEDISHES COURIER") {
                                window.location.href = "https://www.redwireless.ca/courier" + employeeName;
                            } else if (otherCompanies.direct && otherCompanies.direct.indexOf(app.companyInput.val().toUpperCase()) !== -1) {
                                window.location.href = "https://www.redwireless.ca/direct" + employeeName;
                            } else {
                                if (xhr.responseURL) {
                                    window.location.href = xhr.responseURL;
                                } else {
                                    window.location.href = "https://sellcell.formstack.com/forms/rpp?Company=" + app.companyInput.val().toUpperCase()
                                }
                            }
                        }
                    });



                    setTimeout(function () {
                        if ($(".fsForm > .fsError:visible").length > 0) {
                            return;
                        }
                        if ((app.vipForm || app.preferredForm || app.lifeWorksForm) && companyInput.val() === app.notListed) {
                            $('#thanks').modal();
                        }
                        $('.fsSubmitButton').val("Loading Offers...").attr('disabled', 'disabled');
                    }, 200);
                }
            }
        });
    },
    initBanners: function () {
        app.bannerSection = $('.fsSection').first();

        app.bannerSection.find("img").each(function () {
            $(this).attr("data-src", $(this).attr("src"));
            $(this).attr("src", "");
        });

        var found = false;


        if (app.company) {
            $('.image-block').each(function () {
                var alt = $(this).find('img').attr('alt');
                if (alt.indexOf('company-' + app.company.toLowerCase()) !== -1) {
                    found = true;
                    $(this).show().find('img').show();
                }
            });
        }

        if (found) {
            $('img[alt="company-default"]').closest('.sqs-block.image-block').hide();
        } else {
            $('img[alt^="company-"]').closest('.sqs-block.image-block').hide();
            $('img[alt="company-default"]').show().closest('.sqs-block.image-block').show();
        }


    },
    showDefaultBanner: function () {
        app.bannerSection.find("img:visible").attr("src", app.bannerSection.find("img:visible").attr("data-src"));
    },
    initPricingPage: function () {
        if (document.URL.endsWith("pricing") === true) {
            app.pricingPage = true;
            $("input:not(#field106380166)").removeClass('fsRequired');
            $("input:not(#field106380166)").closest('.fsRow').addClass('fsHidden');
        }
    },
    initSkipForm: function () {
        if (app.skipForm) {
            companyInput.val("SKIPTHEDISHES COURIER");
            companyInput.attr("readonly", "readonly");
        }
    },
    initRefereralForm: function () {
        $('.open-referrer, img[alt^="Refer-Friends-Banner"]').on('click', app.openReferForm);


        if (!app.referralsForm) {
            return;
        }
        $('.fsRow').each((index, row) => {
            if ($(row).find('input[type="tel"]').length > 0) {
                $('body').addClass('referrer');
                $(row).addClass('friend');
            }
        });

        $('.friend').slice(2).hide();

        $('.friend:last').after('<button type="button" class="fsSubmitButton" id="add-friend">Add up to 4 more</button>');

        $("#add-friend").on('click', function () {

            $('.friend:hidden:first').show();

            if ($('.friend:hidden').length == 0) {
                $("#add-friend").attr('disabled', true);
                $("#add-friend").attr('style', 'background: #ccc !important');
                $("#add-friend").html("Only 5 friends can be referred");
            } else {
                $("#add-friend").html("Add up to " + $('.friend:hidden').length + " more")
            }
        });
    },
    openReferForm: function () {
        console.log(this);
        var alt = $(this).attr('alt');
        var language = "";
        var employee = '';
        if (alt) {
            var lang = alt.split("--");
            if (lang[1]) {
                language = "#googtrans(en|" + lang[1].split(".")[0] + ")";
            }
        }
        $("<iframe src='https://sellcell.formstack.com/forms/referrals?Employee=" + employee + "" + language + "'></iframe>").appendTo('body').modal();
    },
    initOutFunnel: function () {
        $('.fsForm').addClass('outfunnel-form');
        $('.fsForm input[type="email"]').addClass('outfunnel-input-email');
        $('.fsForm .fsNameFirst input').addClass('outfunnel-input-firstname');
        $('.fsForm .fsNameLast input').addClass('outfunnel-input-lastname');

        window.OFID = "5fcba696beed351a6f2ea1d1";
        (function () {
            var script = document.createElement('script');
            var url = 'https://cdn.outfunnel.com/c.js?v=' + new Date().toISOString().substring(0, 10);
            script.setAttribute('src', url);
            document.getElementsByTagName('head')[0].appendChild(script);
        })();
    },
    initEmployee: function () {
        var employee = app.URL.searchParams.get("Employee") || app.URL.searchParams.get("e");

        if (employee && $("[fs-field-validation-name=Employee] select option[value='" + employee + "']").val() !== undefined) {
            $("[fs-field-validation-name=Employee] select").val(employee)
            app.employee = employee;
        } else if (employee) {
            $("[fs-field-validation-name=Employee] select option").each(function () {
                if (this.text.toUpperCase().indexOf(employee.toUpperCase()) !== -1) {
                    employee = this.text;
                    $("[fs-field-validation-name=Employee] select").val(employee);
                    app.employee = employee;
                }
            });
        } else {
            employee = window.location.pathname.replace("/", "");
            $("[fs-field-validation-name=Employee] select option").each(function () {
                if (this.text.toUpperCase().indexOf(employee.toUpperCase()) !== -1) {
                    employee = this.text;
                    $("[fs-field-validation-name=Employee] select").val(employee);
                    app.employee = employee;
                }
            });
        }

        $("[fs-field-validation-name=Employee] select").trigger("change");
    },

    initCompany: function () {
        var company = app.URL.searchParams.get("Company") || app.URL.searchParams.get("c") || app.URL.searchParams.get("company");;

        var companyInput = $("[fs-field-validation-name=Company] input");

        if (!companyInput.length) {
            companyInput = $("[fs-field-validation-name=Entreprise] input");
        }

        app.companyInput = companyInput;

        if (company) {
            company = company.toUpperCase();
            app.company = company;

            var aliasCompany = app.companies.find((c) => {
                if (!c.a) {
                    return false;
                }

                let alias = c.a;
                if (!alias.length) {
                    return false;
                }

                return alias.indexOf(company) !== -1
            });

            if (app.companies.map(c => c.c).indexOf(company) !== -1) {
                companyInput.val(company);
            } else if (aliasCompany) {
                companyInput.val(aliasCompany.c);
                company = aliasCompany.c;
            } else {
                companyInput.val(app.notListed);
            }

            var cases = ['[data-company="' + encodeURI(company) + '"]', '[data-company="' + company + '"]'];

            if (aliasCompany) {
                let alias = aliasCompany.a;
                alias.forEach(a => {
                    cases.push('[data-company="' + encodeURI(a) + '"]');
                });
            }

            let companyImage = $(cases.join(",").toLowerCase());

            if (companyImage.length) {
                companyImage.attr("src", companyImage.attr("data-src"));
                companyImage.show();
                companyImage.closest('.fsSection').addClass('company-image');
            }
        } else {
            setTimeout(function () {
                app.showDefaultBanner();
            }, 1500);
        }
    },
    initCompanyAutocomplete: function () {

        var minMatchCharLength = 3;
        var minLength = 1000;
        if (app.pricingPage) {
            minMatchCharLength = 1;
            var minLength = 1;
        }

        app.companyInput.autocomplete({
            delay: 0,
            minLength: minLength,
            autoFocus: true,
            source: function (request, response) {
                var results = jQuery.ui.autocomplete.filter(app.companies, request.term);
                var options = {
                    includeScore: true,
                    minMatchCharLength: minMatchCharLength,
                    threshold: 0.25,
                    useExtendedSearch: true,
                    //threshold: 0.25,
                    ignoreLocation: true,
                    keys: ['c', 'a']
                }
                var fuse = new Fuse(app.companies, options)

                request.term = request.term.toUpperCase();
                let searchCompany = null;

                if (request.term.indexOf("BC ") !== -1 || request.term.indexOf(" BC") !== -1) {
                    searchCompany = request.term.replace("BC", "BRITISH COLUMBIA");
                }

                if (request.term.indexOf("AB ") !== -1 || request.term.indexOf(" AB") !== -1) {
                    searchCompany = request.term.replace("AB", "ALBERTA");
                }

                if (request.term.indexOf("SK ") !== -1 || request.term.indexOf(" SK") !== -1) {
                    searchCompany = request.term.replace("SK", "SASKATCHEWAN");
                }

                if (request.term.indexOf("MB ") !== -1 || request.term.indexOf(" MB") !== -1) {
                    searchCompany = request.term.replace("MB", "MANITOBA");
                }


                if (request.term.indexOf("ON ") !== -1 || request.term.indexOf(" ON") !== -1) {
                    searchCompany = request.term.replace("ON", "MANITOBA");
                }

                if (request.term.indexOf("PEI ") !== -1 || request.term.indexOf(" PEI") !== -1) {
                    searchCompany = request.term.replace("PEI", "PRINCE EDWARD ISLAND");
                }

                if (request.term.indexOf("NS ") !== -1 || request.term.indexOf(" NS") !== -1) {
                    searchCompany = request.term.replace("NS", "NOVA SCOTIA");
                }

                if (request.term.indexOf("NFLD ") !== -1 || request.term.indexOf(" NFLD") !== -1) {
                    searchCompany = request.term.replace("NFLD", "NEWFOUNDLAND");
                }

                var aliasCompany = app.companies.find((c) => {
                    if (!c.a) {
                        return false;
                    }

                    let alias = c.a.map(a => a);
                    if (!alias.length) {
                        return false;
                    }

                    return alias.indexOf(request.term.trim()) !== -1
                });

                if (aliasCompany) {
                    request.term = request.term + " | " + aliasCompany.c;
                }

                if (!searchCompany) {
                    searchCompany = app.companies.find(c => {
                        if (c.c.match(/\b([A-Z])/g) && c.c.match(/\b([A-Z])/g).join('').trim() == request.term.trim()) {
                            return true;
                        };
                    });
                }

                if (searchCompany) {
                    request.term = request.term + " | " + searchCompany;
                }

                console.log(request.term);

                resultsOriginal = fuse.search(request.term);
                results = resultsOriginal.map((r) => r.item.c.toUpperCase());
                results = results.slice(0, 20);
                if (results.length === 0 || resultsOriginal[0].score > 0.025 || results.length < 3) {
                    results.push(app.notListed);
                }
                response(results);
            },
            select: function (e, ui) {
                app.companyInput.autocomplete("disable");
                app.formValid = true;
                var company = app.companyInput.val().toUpperCase();

                if (app.vipForm || app.preferredForm || app.lifeWorksForm) {
                    if (ui.item && ui.item.value === app.notListed) {
                        $('[fs-field-validation-name="Searched Company"] input').val(company);
                    } else {
                        $('[fs-field-validation-name="Searched Company"] input').val("");
                    }
                }

                $('[data-company]').hide();
                let companyImage = $('[data-company="' + encodeURI(company) + '"], [data-company="' + company + '"]');
                if (companyImage.length) {
                    companyImage.attr("src", companyImage.attr("data-src"));
                    companyImage.show();
                    companyImage.closest('.fsSection').addClass('company-image');
                } else {
                    $('.fsSection').removeClass('company-image');
                }
            },
            focus: function (event, ui) {
                return false;
            },
            close: function (event, ui) {
                if (!app.pricingPage) {
                    app.companyInput.autocomplete('option', 'minLength', 1000);
                }
            }
        });

        app.companyInput.keypress(function (e) {
            if (e.which == 10 || e.which == 13) {
                app.companyInput.closest('.fsRowBody').find('button').trigger("click");
                e.preventDefault();
            }

            if (e.which !== 13 && !app.pricingPage) {
                app.companyInput.autocomplete("disable");
            }
        });

        app.companyInput.closest('.fsRowBody').on('click', 'button', function () {
            app.companyInput.autocomplete("enable");
            app.companyInput.autocomplete('option', 'minLength', 3);
            app.companyInput.autocomplete('search', app.companyInput.val());
        });

        if (!app.pricingPage) {
            app.companyInput.autocomplete("disable");
        } else {
            app.companyInput.autocomplete('option', 'minLength', 1);
        }

        app.companyInput.after("<button type='button'>Search</button>")

        app.companyInput.attr('autocomplete', 'none');

    },
    initCoupon: function () {
        var couponCode = app.URL.searchParams.get('uqd');
        app.couponInput = $('[fs-field-validation-name="LifeWorks Coupon Code"] input');
        app.couponInput.val(couponCode);

        app.couponInput.change(function () {
            app.couponVerified = false;
            couponCode = $(this).val();
            if (couponCode == "") {
                return;
            }
            app.couponInput.removeClass('correct invalid').addClass('verifing');

            $.ajax({
                type: "POST",
                url: "https://northamerica-northeast1-redwireless.cloudfunctions.net/sheets/coupons",
                data: {
                    coupon: couponCode
                },
                success: function (data, textStatus, request) {
                    app.couponInput.removeClass('verifing');
                    if (data.result === "available") {
                        app.couponVerified = true;
                        app.couponInput.addClass('correct');
                        app.couponInput.closest('.fsRowBody').removeClass('fsValidationError');
                    } else {
                        app.couponVerified = false;
                        app.couponInput.addClass('invalid');
                        app.couponInput.closest('.fsRowBody').addClass('fsValidationError');
                    }
                }
            });
        });

        if (couponCode && app.couponInput.length > 0) {
            app.couponInput.trigger("change");
        }
    },
    loadCompanies: function () {
        var companiesURL = 'https://northamerica-northeast1-redwireless.cloudfunctions.net/companies';
        $.ajax({
            url: companiesURL
        }).done((result) => {

            if (app.lifeWorksForm) {
                app.companies = result.filter(c => c["l"] === 1);
            }

            if (app.pricingPage) {
                app.companies = result;
            }

            app.companies = result;

            app.init();
        });
    },
    isCBUCompany: function (company) {
        let found = app.companies.find(c => c.c === company);
        if (found) {
            return found["t"] === "CBU";
        }
        return false;
    },
    isRPPCompany: function (company) {
        let found = app.companies.find(c => c.c === company);
        if (found) {
            return found["t"] === "RPP";
        }
        return false;
    },
    isDirectCompany: function (company) {
        let found = app.companies.find(c => c.c === company);
        if (found) {
            return found["t"] === "Direct";
        }
        return false;
    },
    loadModal: function () {
        var scriptTag = document.createElement('script');
        scriptTag.src = "https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js";
        document.body.appendChild(scriptTag);
    },
    loadjQuery: function () {
        var script = document.createElement("script");
        script.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
        script.type = 'text/javascript';
        script.onload = function () {
            console.log('load');
            $ = window.jQuery;
            if (app.companies.length > 0) {
                app.init();
            }
        };
        document.getElementsByTagName("head")[0].appendChild(script);
    },
    loadGTranslate: function () {
        $('.fsSection').first().prepend("<div id='google_translate_element2'></div>");

        $('.fsSection').first().prepend('<div class="gflags"><a href="#" onclick="app.changeLanguage(\'en\');return false;" title="English" class="gflag nturl" style="background-position:-0px -0px;"><img src="//gtranslate.net/flags/blank.png" height="16" width="16" alt="English" /></a><a href="#" onclick="app.changeLanguage(\'fr\');return false;" title="French" class="gflag nturl" style="background-position:-200px -100px;"><img src="//gtranslate.net/flags/blank.png" height="16" width="16" alt="French" /></a></div>');



        var script = document.createElement("script");
        script.src = 'https://translate.google.com/translate_a/element.js?cb=app.googleTranslateElementInit2';
        script.type = 'text/javascript';
        script.onload = function () { };
        document.getElementsByTagName("head")[0].appendChild(script);
    },
    googleTranslateElementInit2: function () {
        new google.translate.TranslateElement({
            pageLanguage: 'af',
            autoDisplay: false
        }, 'google_translate_element2');

        window.addEventListener('load', function () {
            if (document.URL.endsWith("offres")) {

            }
            if (app.URL.searchParams.get("lang")) {
                app.changeLanguage(app.URL.searchParams.get("lang"));
            }
        });
    },
    changeLanguage: function (language) {
        console.log('change language', language);
        var selectField = document.querySelector("#google_translate_element2 select");
        for (var i = 0; i < selectField.children.length; i++) {
            var option = selectField.children[i];
            if (option.value == language) {
                selectField.selectedIndex = i;
                selectField.dispatchEvent(new Event('change'));
                break;
            }
        }
    }
}


document.addEventListener('DOMContentLoaded', function () {
    if (window.jQuery) {
        $ = jQuery;
    }
    app.beforeInit();
});